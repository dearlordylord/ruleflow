/**
 * Vulnerability Helper - Determines if entity is vulnerable to attacker
 * Handles special cases like grapple (vulnerable to third parties only)
 */
import type { Entity } from "../entity.js"
import { getComponent } from "../entity.js"
import { hasCondition } from "./conditions.js"

/**
 * Check if entity is vulnerable to attacker
 *
 * @param entity - The entity being attacked
 * @param attacker - The attacking entity
 * @returns true if entity is vulnerable to this specific attacker
 *
 * Special case: Grappled entities are vulnerable to third parties only,
 * not to their grapple opponent
 */
export function isVulnerableTo(
  entity: Entity,
  attacker: Entity
): boolean {
  const conditions = getComponent(entity, "Conditions")
  if (!conditions) return false

  const isVulnerable = hasCondition(conditions.conditions, "Vulnerable")
  if (!isVulnerable) return false

  // Check grapple context
  const grapple = getComponent(entity, "GrappleState")
  if (grapple) {
    // If entity is grappling attacker OR grappled by attacker
    // â†’ NOT vulnerable to them (only to third parties)
    if (grapple.grappledBy === attacker.id) {
      return false
    }
    if (grapple.grappling.includes(attacker.id)) {
      return false
    }
  }

  return true
}
